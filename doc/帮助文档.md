# Roleplay Hub - 帮助与开发文档

**Roleplay Hub** 是一个基于 Web 的单文件（Single-File）AI 角色扮演客户端。它集成了角色管理、聊天交互、世界书（Lorebook）、正则脚本处理以及高级 Prompt 构建系统，旨在提供高度可定制且沉浸式的 AI 角色扮演体验。

---

##  目录

1. [项目简介](#项目简介)
2. [快速开始](#快速开始)
3. [用户指南](#用户指南)
    - [聊天界面](#聊天界面)
    - [角色管理](#角色管理)
    - [预设系统](#预设系统)
    - [世界书 (World Info)](#世界书-world-info)
    - [正则脚本](#正则脚本)
    - [设置](#设置)
4. [开发文档](#开发文档)
    - [技术栈](#技术栈)
    - [核心架构](#核心架构)
    - [数据结构](#数据结构)
    - [Prompt 构建逻辑](#prompt-构建逻辑)
    - [世界书引擎](#世界书引擎)
5. [常见问题 (FAQ)](#常见问题-faq)

---

##  项目简介

Roleplay Hub 是一个纯前端应用，无需后端服务器支持（除了 AI API）。它利用浏览器的 IndexedDB 进行数据存储，支持 OpenAI 兼容格式的 API 接口。

**核心特性：**
*   **单文件架构**：核心逻辑全部包含在 `index.html` 中，部署简单。
*   **SillyTavern 兼容**：支持导入/导出 SillyTavern 格式的角色卡（PNG/JSON）。
*   **高级世界书**：内置强大的世界书引擎，支持递归扫描、逻辑组合触发、Token 预算控制。
*   **正则脚本**：支持对输入/输出进行实时正则替换，用于隐藏思维链、优化排版或实现特殊效果。
*   **流式响应**：支持打字机效果的流式输出。
*   **移动端适配**：响应式设计，完美支持移动端操作。

---

##  快速开始

### 1. 运行项目
由于是纯静态页面，您只需在浏览器中打开 `index.html` 即可运行。
*   **本地运行**：双击 `index.html`。
*   **部署**：将文件上传至任何静态网页托管服务（如 GitHub Pages, Vercel）。

### 2. 初始化配置
首次进入时，请前往 **设置 (Settings)** 页面配置 API：
1.  **API 地址**：输入兼容 OpenAI 格式的 API 端点（例如 `https://api.openai.com` 或第三方中转）。
2.  **API Key**：输入您的 API 密钥。
3.  **模型**：点击输入框选择或手动输入模型名称（如 `gpt-4`, `claude-3-opus`）。
4.  **用户设置**：设置您的用户名称和头像。

---

##  用户指南

### 聊天界面
*   **发送消息**：在底部输入框输入内容，按回车发送（Shift+Enter 换行）。
*   **消息操作**：
    *   **重试**：点击消息下方的刷新图标重新生成。
    *   **编辑**：目前支持通过正则脚本修正，或直接删除后重发。
    *   **删除**：点击垃圾桶图标删除消息。
    *   **复制**：点击复制图标。
*   **快捷指令**：支持 `/` 触发特定功能（需脚本支持）。

### 角色管理
*   **导入角色**：支持 `.json` 和 `.png` (Tavern Card V2) 格式。
*   **导出角色**：将当前角色导出为包含元数据的 PNG 图片。
*   **编辑角色**：
    *   **基础**：头像、名称。
    *   **描述/人设**：核心 Prompt 部分。
    *   **开场白**：第一条消息。
    *   **场景**：当前环境设定。

### 预设系统
预设 (Presets) 是系统提示词 (System Prompt) 的集合。
*   **破限**：解除 AI 的安全限制。
*   **防抢话**：防止 AI 扮演用户。
*   **叙事视角**：切换第二人称（你）或第三人称。
*   **拖拽排序**：预设的顺序会影响 Prompt 的最终效果，通常建议将“破限”放在较前位置。

### 世界书 (World Info)
世界书用于在特定关键词出现时，动态向 AI 注入背景设定。
*   **触发机制**：
    *   **Keys (主关键词)**：必须匹配的词。
    *   **Secondary Keys (次级关键词)**：配合逻辑门（AND/NOT/ANY/ALL）使用。
    *   **Constant (常驻)**：无视概率和关键词，始终注入。
*   **插入位置**：决定条目在 Prompt 中的位置（如系统提示词顶部、角色定义前、聊天记录中等）。
*   **高级设置**：
    *   **递归扫描**：条目内容触发其他条目。
    *   **时效控制**：设置条目激活后的持续轮数或冷却时间。

### 正则脚本
用于处理文本的查找和替换。
*   **Placement (生效位置)**：
    *   **User**：在发送给 AI 之前处理用户的输入。
    *   **AI**：在 AI 输出内容后处理（用于显示或再次输入）。
*   **模式**：
    *   **Markdown Only**：仅改变显示效果，不改变实际聊天记录。
    *   **Prompt Only**：仅改变发送给 AI 的 Prompt，不改变显示。
*   **常用脚本**：
    *   `Auto Replace {{user}}`：自动将 `{{user}}` 替换为用户名。
    *   `隐藏正文的thinking`：隐藏思维链模型的思考过程 (`<think>...</think>`)。

---

##  开发文档

### 技术栈
*   **Core**: HTML5, JavaScript (ES6+)
*   **Framework**: Vue.js 3 (Composition API, CDN引入)
*   **Styling**: Tailwind CSS (CDN引入)
*   **Utils**:
    *   `marked.js`: Markdown 渲染
    *   `dompurify`: XSS 防护与 HTML 净化
    *   `IndexedDB`: 本地大数据存储

### 核心架构

#### 1. 数据持久化 (IndexedDB)
项目放弃了 `localStorage`，改用 `IndexedDB` 以支持存储大量角色卡图片和聊天记录。
*   **Database**: `SillyTavernDB`
*   **Stores**:
    *   `silly_tavern_characters`: 角色列表
    *   `silly_tavern_chat_{uuid}`: 特定角色的聊天记录
    *   `silly_tavern_settings`: 全局设置
    *   `silly_tavern_worldinfo`: 全局世界书

#### 2. Prompt 构建逻辑
Prompt 的构建是动态的，遵循以下顺序（从上到下）：
1.  **Presets**: 启用的预设内容。
2.  **World Info (System Top)**: 标记为顶部的世界书。
3.  **Character Definition**:
    *   Name, Description, Personality, Scenario
    *   Mes Examples (对话示例)
4.  **World Info (Character Related)**: 标记为角色前/后的世界书。
5.  **Author's Note**: 作者注释（通常用于强调当前状态）。
6.  **User Info**: 用户昵称和描述。
7.  **Chat History**: 聊天记录（包含动态插入的 World Info）。

#### 3. 世界书引擎 (World Info Engine)
位于 `generateResponse` 函数内部，执行流程如下：
1.  **初始扫描**: 扫描最近 N 条聊天记录。
2.  **关键词匹配**: 检查 `keys` 和 `secondary_keys`。
3.  **递归扫描**: 如果启用了递归，扫描已触发条目的内容，查找新触发的条目。
4.  **分组与评分**: 处理 `Group` 属性，同一组内根据权重或评分选择胜出者。
5.  **Token 预算**: 根据 `tokenBudget` 或 `contextPercent` 限制最终插入的条目数量。
6.  **注入**: 将筛选出的条目按 `position` 和 `order` 插入到 Prompt 的不同位置。

#### 4. 角色卡数据结构 (V2 Spec)
支持 Tavern Card V2 规范：
```json
{
  "spec": "chara_card_v2",
  "spec_version": "2.0",
  "data": {
    "name": "角色名",
    "description": "描述",
    "personality": "人设",
    "first_mes": "开场白",
    "mes_example": "对话示例",
    "scenario": "场景",
    "character_book": { "entries": [...] },
    "extensions": { "regex_scripts": [...] }
  }
}
```

### 关键函数解析

*   `generateResponse(startTime)`: 核心生成逻辑。负责组装 Prompt，调用 API，处理流式返回，以及错误重试。
*   `renderMarkdown(text)`: 渲染消息。集成了 `marked.js` 和 `DOMPurify`，并包含对 HTML 卡片（iframe）的特殊处理逻辑。
*   `processRegex(text, options)`: 执行正则替换。支持深度检查和位置检查（User/AI）。
*   `importCharacter(event)`: 处理角色导入。包含 PNG Chunk 读取逻辑（解析 `tEXt` 或 `iTXt` 段中的 Base64 数据）。

---

##  常见问题 (FAQ)

**Q: 为什么我的 API Key 无法保存？**
A: 请检查浏览器是否开启了“无痕模式”或禁用了 IndexedDB。数据存储在本地浏览器数据库中。

**Q: 如何开启 R18 / NSFW 模式？**
A: 请在“预设”中启用“色情内容增强”预设，并确保 API 使用的模型支持 NSFW 内容。

**Q: 角色卡图片加载失败？**
A: 确保导入的是包含元数据的标准 PNG 格式角色卡。如果是 WebP 或 JPG，可能丢失了元数据。

**Q: 聊天记录丢失了？**
A: 聊天记录绑定在角色的 UUID 上。如果删除了角色并重新导入，UUID 会变化，导致旧记录无法关联。请谨慎删除角色。

**Q: 自动生图如何工作？**
A: 这是一个特殊的世界书条目。开启后，系统会尝试识别场景并生成 `<image>` 标签，前端通过正则将其替换为绘图 API 的调用结果。

---

*文档版本: 1.0.0 | 更新时间: 2025-12-28*